---
# run on localhost instead of Client VMs
- hosts: localhost
  tasks:
    - name: Install kubernetes
      # install Kubernetes
      # if .kube directory does not exist, create it and copy kubernetes admin configuration to it
      # then set ownership of kubernetes admin config file needed to run kubernetes
      shell: |
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-arm64
        sudo install minikube-linux-arm64 /usr/local/bin/minikube
        mkdir -p $HOME/.kube
        sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
        sudo chown $(id -u):$(id -g) $HOME/.kube/config
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        curl -LO "https://dl.k8s.io/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl.sha256"
        echo "$(<kubectl.sha256) kubectl" | sha256sum --check
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        mkdir -p ~/.local/bin/kubectl
        mv ./kubectl ~/.local/bin/kubectl

       
    - name: Initialize kubernetes cluster
      # start kubernetes cluster
      shell: minikube start
      register: output
    - name: Clone repository if does not exist
      # if git project does not exist, clone it
      # otherwise update project from SCM
      shell: |
        if [ ! -d "~/2020_03_DO_Boston_casestudy_part_1/" ]
            then
            git clone https://github.com/nmm131/2020_03_DO_Boston_casestudy_part_1.git
        else
            dir('~/2020_03_DO_Boston_casestudy_part_1/') {
                git pull
            }
        fi
      
    - name: Apply kubernetes.yaml to cluster
      # apply a configuration change to jenkins resource from a file
      command: kubectl apply -f ~/2020_03_DO_Boston_casestudy_part_1/kubernetes-jenkins.yaml